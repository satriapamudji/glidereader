<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glide Reader - Full Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@mozilla/readability@0.6.0/Readability.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #09090b;
            color: #fff;
        }
        .test-section {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #18181b;
            border-radius: 12px;
            border: 1px solid #27272a;
        }
        .test-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }
        .test-description {
            color: #a1a1aa;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .test-button {
            background: linear-gradient(to right, #f59e0b, #ef4444);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            margin-right: 12px;
            margin-bottom: 8px;
        }
        .test-button:hover {
            transform: scale(1.05);
        }
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success {
            background: #14532d;
            color: #86efac;
            border: 1px solid #166534;
        }
        .status.error {
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #991b1b;
        }
        .status.info {
            background: #1e3a8a;
            color: #93c5fd;
            border: 1px solid #1e40af;
        }
        textarea {
            width: 100%;
            height: 120px;
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 6px;
            padding: 12px;
            color: #d4d4d8;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 12px;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #27272a;
            display: flex;
            align-items: center;
        }
        .feature-list li:last-child {
            border-bottom: none;
        }
        .feature-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .feature-status.implemented {
            background: #22c55e;
        }
        .feature-status.partial {
            background: #f59e0b;
        }
        .feature-status.missing {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // RSVP Tokenizer (simplified version for testing)
        function calculateORPIndex(word) {
            const len = word.length;
            if (len <= 2) return 0;
            if (len <= 5) return 1;
            if (len <= 9) return 2;
            if (len <= 13) return 3;
            return 4;
        }

        function calculatePauseMultiplier(text) {
            const trimmed = text.trim();
            if (/\n\s*\n/.test(text)) return 2.0; // paragraph
            const lastChar = trimmed.at(-1);
            if (lastChar === '.' || lastChar === '!' || lastChar === '?') return 1.2;
            if (lastChar === ',' || lastChar === ';' || lastChar === ':') return 0.4;
            return 0;
        }

        function tokenize(text) {
            const lines = text.split(/\r?\n/);
            const tokens = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const words = line.split(/\s+/);
                for (let j = 0; j < words.length; j++) {
                    const word = words[j];
                    if (!word) continue;
                    const isEndOfParagraph = j === words.length - 1 && i < lines.length - 1;
                    let pauseMultiplier = calculatePauseMultiplier(word);
                    if (isEndOfParagraph) {
                        pauseMultiplier = Math.max(pauseMultiplier, 2.0);
                    }
                    tokens.push({
                        text: word,
                        orpIndex: calculateORPIndex(word),
                        pauseMultiplier,
                    });
                }
            }
            return tokens;
        }

        // Test Component
        function TestApp() {
            const [testResults, setTestResults] = useState({});
            const [testText, setTestText] = useState(
                "Glide Reader transforms any text into an immersive speed reading experience. " +
                "Each word appears with a red anchor letter that stays fixed in the center. " +
                "Your eyes never need to move, eliminating saccades and reducing fatigue. " +
                "Adjust the speed to find your optimal reading flow."
            );
            const [isReading, setIsReading] = useState(false);
            const [currentWordIndex, setCurrentWordIndex] = useState(0);
            const [wpm, setWpm] = useState(300);

            const tokens = tokenize(testText);

            // RSVP Engine Test
            useEffect(() => {
                if (!isReading || currentWordIndex >= tokens.length) {
                    if (currentWordIndex >= tokens.length) {
                        setIsReading(false);
                    }
                    return;
                }

                const token = tokens[currentWordIndex];
                const baseMs = 60000 / wpm;
                const delay = baseMs * (1 + token.pauseMultiplier);

                const timer = setTimeout(() => {
                    setCurrentWordIndex(prev => prev + 1);
                }, delay);

                return () => clearTimeout(timer);
            }, [isReading, currentWordIndex, tokens, wpm]);

            const runTests = () => {
                const results = {};

                // Test 1: Tokenization
                try {
                    const testTokens = tokenize("Hello world! How are you?");
                    results.tokenization = {
                        status: testTokens.length === 6 ? 'success' : 'error',
                        message: `Tokenized ${testTokens.length} words from "Hello world! How are you?"`
                    };
                } catch (error) {
                    results.tokenization = {
                        status: 'error',
                        message: `Tokenization failed: ${error.message}`
                    };
                }

                // Test 2: ORP Calculation
                try {
                    const orpTests = [
                        { word: "cat", expected: 0 },
                        { word: "hello", expected: 1 },
                        { word: "reading", expected: 2 },
                        { word: "presentation", expected: 3 }
                    ];
                    let orpPassed = 0;
                    orpTests.forEach(test => {
                        if (calculateORPIndex(test.word) === test.expected) orpPassed++;
                    });
                    results.orp = {
                        status: orpPassed === orpTests.length ? 'success' : 'error',
                        message: `ORP calculation: ${orpPassed}/${orpTests.length} tests passed`
                    };
                } catch (error) {
                    results.orp = {
                        status: 'error',
                        message: `ORP calculation failed: ${error.message}`
                    };
                }

                // Test 3: Pause Multiplier
                try {
                    const pauseTests = [
                        { text: "word", expected: 0 },
                        { text: "word,", expected: 0.4 },
                        { text: "word.", expected: 1.2 }
                    ];
                    let pausePassed = 0;
                    pauseTests.forEach(test => {
                        if (Math.abs(calculatePauseMultiplier(test.text) - test.expected) < 0.01) pausePassed++;
                    });
                    results.pause = {
                        status: pausePassed === pauseTests.length ? 'success' : 'error',
                        message: `Pause multiplier: ${pausePassed}/${pauseTests.length} tests passed`
                    };
                } catch (error) {
                    results.pause = {
                        status: 'error',
                        message: `Pause multiplier failed: ${error.message}`
                    };
                }

                // Test 4: Readability
                try {
                    if (typeof Readability !== 'undefined') {
                        results.readability = {
                            status: 'success',
                            message: 'Readability library loaded successfully'
                        };
                    } else {
                        results.readability = {
                            status: 'error',
                            message: 'Readability library not available'
                        };
                    }
                } catch (error) {
                    results.readability = {
                        status: 'error',
                        message: `Readability test failed: ${error.message}`
                    };
                }

                setTestResults(results);
            };

            const currentToken = tokens[currentWordIndex];
            let wordDisplay = 'Press Play to start reading';
            let wordTransform = 'translateX(0)';
            
            if (currentToken) {
                const prefix = currentToken.text.slice(0, currentToken.orpIndex);
                const orp = currentToken.text[currentToken.orpIndex] || '';
                const suffix = currentToken.text.slice(currentToken.orpIndex + 1);
                
                // Calculate approximate character widths for alignment
                const avgCharWidth = 28; // Approximate width at 48px font
                const prefixWidth = prefix.length * avgCharWidth;
                const orpWidth = avgCharWidth;
                const orpOffset = prefixWidth + (orpWidth / 2);
                
                // Position word so ORP aligns with center line
                wordTransform = `translateX(calc(-50% + ${orpOffset}px))`;
                
                wordDisplay = `<span style="color: rgba(255,255,255,0.7)">${prefix}</span><span style="color: #ef4444; font-weight: bold;">${orp}</span><span style="color: rgba(255,255,255,0.7)">${suffix}</span>`;
            }

            const features = [
                { name: 'RSVP Tokenization', status: 'implemented' },
                { name: 'ORP Anchor Letter', status: 'implemented' },
                { name: 'Punctuation-aware Pauses', status: 'implemented' },
                { name: 'WPM Control (200-900)', status: 'implemented' },
                { name: 'Progress Bar', status: 'implemented' },
                { name: 'Keyboard Shortcuts', status: 'partial' },
                { name: 'Web Content Extraction', status: 'implemented' },
                { name: 'Browser Extension (Alt+F)', status: 'implemented' },
                { name: 'Local Storage (Settings)', status: 'implemented' },
                { name: 'PDF Import', status: 'missing' },
                { name: 'Library View', status: 'missing' },
                { name: 'Stats & Training', status: 'missing' },
                { name: 'PWA Support', status: 'partial' },
            ];

            return (
                <div style={{ padding: '20px' }}>
                    <div style={{ textAlign: 'center', marginBottom: '40px' }}>
                        <div style={{
                            width: '64px',
                            height: '64px',
                            borderRadius: '12px',
                            background: 'linear-gradient(to bottom right, #f59e0b, #ef4444)',
                            display: 'inline-flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '24px',
                            fontWeight: 'bold',
                            color: '#000',
                            marginBottom: '16px'
                        }}>G</div>
                        <h1 style={{ fontSize: '32px', fontWeight: '600', margin: '0 0 8px 0' }}>Glide Reader</h1>
                        <p style={{ color: '#71717a', margin: 0 }}>Speed Reading with RSVP - Test Environment</p>
                    </div>

                    <div className="test-section">
                        <div className="test-title">üß™ Core Engine Tests</div>
                        <div className="test-description">
                            Test the fundamental RSVP engine components: tokenization, ORP calculation, and pause multipliers.
                        </div>
                        <button className="test-button" onClick={runTests}>
                            Run Core Tests
                        </button>
                        {Object.keys(testResults).length > 0 && (
                            <div style={{ marginTop: '20px' }}>
                                {Object.entries(testResults).map(([key, result]) => (
                                    <div key={key} className={`status ${result.status}`}>
                                        <strong>{key}:</strong> {result.message}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="test-section">
                        <div className="test-title">üìñ RSVP Reading Test</div>
                        <div className="test-description">
                            Test the actual reading experience with ORP anchor and timing.
                        </div>
                        <textarea
                            value={testText}
                            onChange={(e) => {
                                setTestText(e.target.value);
                                setCurrentWordIndex(0);
                                setIsReading(false);
                            }}
                            placeholder="Enter text to read..."
                        />
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                            <button
                                className="test-button"
                                onClick={() => setIsReading(!isReading)}
                                disabled={tokens.length === 0}
                            >
                                {isReading ? '‚è∏ Pause' : '‚ñ∂ Play'}
                            </button>
                            <button
                                className="test-button"
                                onClick={() => setCurrentWordIndex(0)}
                            >
                                ‚Ü∫ Reset
                            </button>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <label style={{ color: '#a1a1aa' }}>WPM:</label>
                                <input
                                    type="number"
                                    value={wpm}
                                    onChange={(e) => setWpm(parseInt(e.target.value) || 300)}
                                    min="200"
                                    max="900"
                                    step="10"
                                    style={{
                                        width: '80px',
                                        background: '#09090b',
                                        border: '1px solid #27272a',
                                        color: '#fff',
                                        padding: '4px 8px',
                                        borderRadius: '4px'
                                    }}
                                />
                            </div>
                        </div>
                        <div style={{
                            background: '#000',
                            border: '1px solid #27272a',
                            borderRadius: '8px',
                            padding: '40px',
                            textAlign: 'center',
                            fontSize: '48px',
                            minHeight: '120px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            position: 'relative'
                        }}>
                            {/* Single vertical ORP line */}
                            <div style={{
                                position: 'absolute',
                                left: '50%',
                                top: '0',
                                bottom: '0',
                                width: '1px',
                                background: '#ef4444',
                                transform: 'translateX(-50%)'
                            }} />
                            <span style={{ transform: wordTransform }} dangerouslySetInnerHTML={{ __html: wordDisplay }} />
                        </div>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            marginTop: '16px',
                            fontSize: '14px',
                            color: '#71717a'
                        }}>
                            <span>Word {currentWordIndex + 1} / {tokens.length}</span>
                            <span>{Math.round((currentWordIndex / tokens.length) * 100)}% complete</span>
                        </div>
                        <div style={{
                            height: '4px',
                            background: '#27272a',
                            borderRadius: '2px',
                            marginTop: '8px',
                            overflow: 'hidden'
                        }}>
                            <div style={{
                                height: '100%',
                                background: 'linear-gradient(to right, #f59e0b, #ef4444)',
                                width: `${(currentWordIndex / tokens.length) * 100}%`,
                                transition: 'width 0.1s linear'
                            }} />
                        </div>
                    </div>

                    <div className="test-section">
                        <div className="test-title">‚úÖ Feature Implementation Status</div>
                        <div className="test-description">
                            Overview of implemented features according to the specification.
                        </div>
                        <ul className="feature-list">
                            {features.map(feature => (
                                <li key={feature.name}>
                                    <div className={`feature-status ${feature.status}`} />
                                    <span>{feature.name}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="test-section">
                        <div className="test-title">üöÄ Next Steps</div>
                        <div className="test-description">
                            The core RSVP engine is working! Here's what needs to be done for a complete MVP:
                        </div>
                        <ul style={{ color: '#a1a1aa', lineHeight: '1.8' }}>
                            <li>‚úÖ <strong>Core RSVP Engine</strong> - Working with ORP anchor and pauses</li>
                            <li>‚úÖ <strong>Web App Interface</strong> - React components ready</li>
                            <li>‚úÖ <strong>Browser Extension</strong> - Alt+F functionality implemented</li>
                            <li>üîÑ <strong>Build System</strong> - Need to resolve environment issues</li>
                            <li>‚è≥ <strong>PDF Import</strong> - PDF.js integration needed</li>
                            <li>‚è≥ <strong>Library & Storage</strong> - IndexedDB setup exists</li>
                            <li>‚è≥ <strong>PWA Features</strong> - Service worker configuration ready</li>
                        </ul>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>
